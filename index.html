<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agentic Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#111; color:#eee; margin:0; }
    h2 { text-align:center; padding:1rem 0; }
    .toolbar { max-width:700px; margin:0 auto 1rem; display:flex; gap:.5rem; }
    #api-key, #chat-input {
      flex:1; padding:.5rem; border-radius:5px; border:1px solid #444;
      background:#1a1a1a; color:#eee;
    }
    button {
      padding:.5rem 1rem; border:none; border-radius:5px;
      background:#38bdf8; color:#000; cursor:pointer;
    }
    button:hover { background:#0ea5e9; }
    #blackbox {
      max-width:700px; margin:0 auto 2rem; background:#0d0d0d;
      border:2px solid #333; border-radius:8px;
      padding:1rem; box-shadow:0 0 10px #000;
    }
    #chat-output { margin-bottom:1rem; white-space:pre-wrap; }
    #console-output {
      background:#222; padding:.75rem; border-radius:6px;
      font-family:monospace; min-height:2.5rem;
    }
    pre {
      background:#1a1a1a; padding:.75rem; border-radius:6px; overflow:auto;
    }
    #apikey-modal {
      position:fixed; inset:0; background:#0008;
      display:none; align-items:center; justify-content:center;
    }
    #apikey-modal-content {
      background:#fff; color:#000; padding:2rem; border-radius:8px;
      width:90%; max-width:400px; text-align:center;
    }
    #user-api-key {
      width:100%; padding:.5rem; margin-top:.5rem;
    }
    #last-prompt {
      max-width:700px; margin:0 auto 1rem; padding:.5rem;
      color:#aaa; font-style:italic; text-align:center;
    }
  </style>
</head>
<body>
  <h2>Agentic Chat</h2>

  <div class="toolbar">
    <input id="api-key" type="password" placeholder="OpenAI API Key">
  </div>

  <div class="toolbar">
    <input id="chat-input" placeholder="Ask anything…">
    <button onclick="sendChat()">Send</button>
  </div>

  <div id="last-prompt">(no input yet)</div>

  <div id="blackbox">
    <div id="chat-output"></div>
    <div id="console-output">(results appear here)</div>
  </div>

  <!-- API Key Modal -->
  <div id="apikey-modal">
    <div id="apikey-modal-content">
      <p>API key needed for<br><strong id="api-service-name"></strong></p>
      <input id="user-api-key" type="password" placeholder="Paste key">
      <br><br><button onclick="submitUserApiKey()">OK</button>
    </div>
  </div>

  <script>
    const systemPrompt = `
You are an autonomous agent in a browser.
Only reply with JavaScript in a single code block.
If an external service needs a key use the placeholder "YOUR_API_KEY".
Always \`return\` the final value.
    `;

    const serviceKeys = {};
    let pendingCode = null, pendingDomain = null;

    function extractDomain(code) {
      const m = code.match(/https?:\/\/([^/'"]+)/);
      return m ? m[1] : "Unknown Service";
    }

    /**
     * Execute LLM-generated code inside a sandboxed iframe so it cannot
     * access the parent page's DOM, API keys, cookies, or localStorage.
     * The iframe communicates results back via postMessage.
     */
    function runCode(code) {
      const out = document.getElementById('console-output');
      out.textContent = '(running in sandbox…)';

      // Build a self-contained HTML document that runs the code and posts the result back
      const iframeHTML = `<!DOCTYPE html><html><body><script>
        (async () => {
          try {
            const __result = await (async () => { ${code} })();
            parent.postMessage({ type: 'sandbox-result', ok: true, value: String(__result) }, '*');
          } catch (e) {
            parent.postMessage({ type: 'sandbox-result', ok: false, value: 'Error: ' + e.message }, '*');
          }
        })();
      <\/script></body></html>`;

      // Remove any previous sandbox iframe
      const prev = document.getElementById('sandbox-frame');
      if (prev) prev.remove();

      const iframe = document.createElement('iframe');
      iframe.id = 'sandbox-frame';
      // sandbox="allow-scripts" — NO allow-same-origin, so the iframe
      // cannot access the parent's DOM, cookies, localStorage, or JS variables
      iframe.sandbox = 'allow-scripts';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      // Listen for the result
      const timeout = setTimeout(() => {
        out.textContent = '(sandbox timed out after 30s)';
        cleanup();
      }, 30000);

      function cleanup() {
        clearTimeout(timeout);
        window.removeEventListener('message', onMessage);
        const f = document.getElementById('sandbox-frame');
        if (f) f.remove();
      }

      function onMessage(e) {
        if (e.data && e.data.type === 'sandbox-result') {
          out.textContent = e.data.ok ? e.data.value : e.data.value;
          cleanup();
        }
      }

      window.addEventListener('message', onMessage);
      iframe.srcdoc = iframeHTML;
    }

    function askKey(domain, code) {
      pendingCode = code;
      pendingDomain = domain;
      document.getElementById('api-service-name').textContent = domain;
      document.getElementById('apikey-modal').style.display = 'flex';
      document.getElementById('user-api-key').focus();
    }

    function submitUserApiKey() {
      const k = document.getElementById('user-api-key').value.trim();
      if (!k) return;
      serviceKeys[pendingDomain] = k;
      document.getElementById('apikey-modal').style.display = 'none';
      runCode(pendingCode.replace(/YOUR_API_KEY/g, k));
      pendingCode = pendingDomain = null;
      document.getElementById('user-api-key').value = '';
    }

    function updateLastPrompt(prompt) {
      document.getElementById('last-prompt').textContent = `Last input: ${prompt}`;
    }

    let isSending = false;

    async function sendChat() {
      if (isSending) return;

      const openai = document.getElementById('api-key');
      const key = openai.value.trim();
      const prompt = document.getElementById('chat-input').value.trim();
      if (!key || !prompt) {
        alert('Enter both your OpenAI key and a question.');
        return;
      }

      const sendBtn = document.querySelector('.toolbar button');
      isSending = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending…';

      updateLastPrompt(prompt);
      if (!openai.dataset.hidden) {
        openai.style.display = 'none';
        openai.dataset.hidden = '1';
      }

      const chatOut = document.getElementById('chat-output');
      chatOut.textContent = 'Thinking…';
      document.getElementById('console-output').textContent = '(processing)';

      try {
        const rsp = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${key}`
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: prompt }
            ]
          })
        });

        if (!rsp.ok) {
          chatOut.textContent = 'OpenAI error ' + rsp.status;
          document.getElementById('console-output').textContent = '(request failed)';
          return;
        }

        const data = await rsp.json();
        const reply = data.choices?.[0]?.message?.content || 'No response';
        const codeMatch = reply.match(/```(?:js|javascript)?\n([\s\S]*?)```/i);

        if (codeMatch) {
          const code = codeMatch[1];
          const pre = document.createElement('pre');
          pre.textContent = code;
          chatOut.innerHTML = '';
          chatOut.appendChild(pre);
          if (/YOUR_API_KEY/.test(code)) {
            const domain = extractDomain(code);
            if (serviceKeys[domain]) runCode(code.replace(/YOUR_API_KEY/g, serviceKeys[domain]));
            else askKey(domain, code);
          } else {
            runCode(code);
          }
        } else {
          chatOut.textContent = reply;
          document.getElementById('console-output').textContent = '(no code to run)';
        }
      } catch (err) {
        chatOut.textContent = 'Network error: ' + err.message;
        document.getElementById('console-output').textContent = '(request failed)';
      } finally {
        isSending = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        document.getElementById('chat-input').value = '';
      }
    }

    // Pressing Enter submits the chat
    document.getElementById('chat-input').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendChat();
      }
    });

    // Pressing Enter in API key modal submits the key
    document.getElementById('user-api-key').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitUserApiKey();
      }
    });
  </script>
</body>
</html>
